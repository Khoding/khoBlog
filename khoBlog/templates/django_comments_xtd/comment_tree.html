{% load i18n %}
{% load comments %}
{% load comments_xtd %}

{% for item in comments %}
    <div id="comment-{{ item.comment.id }}" class="card shadow mb-2 pb-0 pe-0">
        <div class="card-body">
            <div class="comment pb-2">
                <h4>
                    {% if not item.comment.user and not item.comment.alias_user and item.comment.user_name %}
                        {% if not item.comment.is_removed or user.is_superuser %}
                            <span>{{ item.comment.user_name }}</span>
                        {% endif %}
                    {% elif item.comment.alias_user or item.comment.user and item.comment.alias_user %}
                        {% if user.is_superuser %}
                            <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                            <span class="text-small text-muted">{{ item.comment.alias_user }}</span>
                        {% else %}
                            {% if not item.comment.is_removed %}
                                {{ item.comment.alias_user }}
                            {% else %}
                                <span class="text-muted">This comment has been removed.</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        {% if user.is_superuser or user.id == item.comment.user.id %}
                            <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                        {% elif item.comment.user.owner and user.is_authenticated %}
                            <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                        {% else %}
                            <span>{{ item.comment.user }}</span>
                        {% endif %}
                    {% endif %}
                    {% if item.comment.user and item.comment.user|has_permission:"django_comments.can_moderate" %}&nbsp;<span class="badge bg-secondary p-1">Moderator</span>{% endif %}
                </h4>
                <h6 class="text-small d-flex">
                    {% spaceless %}
                        <div class="me-auto">{{ item.comment.submit_date|date:'l, d F Y' }}&nbsp;<a href="{% get_comment_permalink item.comment %}"><i class="bi bi-link-45deg"></i> Permalink</a></div>
                    {% endspaceless %}
                    <span>
                        {% if not item.comment.is_removed %}
                            {% if perms.comments.can_moderate %}
                                {% if item.flagged_count %}
                                    <span class="badge bg-danger" title="{% blocktrans count counter=item.flagged_count %}A user has flagged this comment as inappropriate.{% plural %}{{ counter }} users have flagged this comment as inappropriate.{% endblocktrans %}">{{ item.flagged_count }}</span>
                                {% endif %}
                            {% endif %}
                            {% if allow_flagging and item.flagged %}
                                <i class="bi bi-flag-fill text-danger" title="{% trans 'comment flagged' %}"></i>
                            {% elif allow_flagging %}
                                    <a class="mutedlink"
                                        href="{% url 'comments-flag' item.comment.pk %}">
                                        <i class="bi bi-flag-fill"></i>
                                    </a>
                            {% endif %}
                            {% if perms.comments.can_moderate %}
                                <a class="mutedlink"
                                href="{% url 'comments-delete' item.comment.pk %}"><i class="bi bi-trash"></i></a>
                            {% endif %}
                        {% endif %}
                    </span>
                </h6>
                {% if item.comment.is_removed %}
                    {% if not user.is_superuser %}
                        <p class="text-muted{% if not allow_feedback and not item.comment.allow_thread %} pb-2{% endif %}"><em>This comment has been removed.</em></p>
                    {% else %}
                        <div class="content text-muted{% if not allow_feedback and not item.comment.allow_thread %} pb-2{% endif %}">
                            <em>
                                {% if item.comment.title %}
                                    <h4>{{ item.comment.title }}</h4>
                                {% endif %}

                                {% include "includes/django_comments_xtd/comment_content.html" with content=item.comment.comment %}
                            </em>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="content{% if not allow_feedback and not item.comment.allow_thread %} pb-2{% endif %}">
                        {% if item.comment.title %}
                            <h4>{{ item.comment.title }}</h4>
                        {% endif %}

                        {% include "includes/django_comments_xtd/comment_content.html" with content=item.comment.comment %}
                    </div>
                    {% if allow_feedback %}
                        {% include "includes/django_comments_xtd/user_feedback.html" %}
                    {% endif %}
                    {% if item.comment.allow_thread and not item.comment.is_removed %}
                        {% if allow_feedback %}&nbsp;&nbsp;<span class="text-muted">&bull;</span>&nbsp;&nbsp;{% endif %}<a class="small mutedlink" href="{{ item.comment.get_reply_url }}">{% trans "Reply" %}</a>
                    {% endif %}
                {% endif %}
            </div>
            {% if not item.comment.is_removed and item.children %}
                {% render_xtdcomment_tree with comments=item.children %}
            {% endif %}
        </div>
    </div>
{% endfor %}
