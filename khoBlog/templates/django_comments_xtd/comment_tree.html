{% load i18n %}
{% load comments %}
{% load comments_xtd %}

{% for item in comments %}
    <div id="comment-{{ item.comment.id }}" class="card shadow mb-2 pb-0 pe-0">
        <div class="card-body">
            <div class="comment pb-2">
                <h4>
                    {% if not item.comment.user and not item.comment.alias_user and item.comment.user_name %}
                        {% if not item.comment.is_removed or user.is_superuser %}
                            {{ item.comment.user_name }}
                        {% endif %}
                    {% elif item.comment.alias_user or item.comment.user and item.comment.alias_user %}
                        {% if user.is_superuser %}
                            <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                            <span class="text-small text-muted">{{ item.comment.alias_user }}</span>
                        {% else %}
                            {% if not item.comment.is_removed %}
                                {{ item.comment.alias_user }}
                            {% else %}
                                <span class="text-muted">This comment has been removed.</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        {% if user.is_superuser or user.id == item.comment.user.id %}
                            <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                        {% elif item.comment.user.owner and user.is_authenticated %}
                            <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                        {% else %}
                            {{ item.comment.user }}
                        {% endif %}
                    {% endif %}
                </h4>
                <h6 class="text-small d-flex">
                    {% spaceless %}
                        <div class="me-auto">{{ item.comment.submit_date|date:'l, d F Y' }}&nbsp;-&nbsp;{% if item.comment.url and not item.comment.is_removed %}<a href="{{ item.comment.url }}" target="_new">{% endif %}{{ item.comment.name }}{% if item.comment.url %}</a>{% endif %}{% if item.comment.user and item.comment.user|has_permission:"django_comments.can_moderate" %}&nbsp;<span class="badge bg-secondary">Moderator</span>{% endif %}&nbsp;&nbsp;<a href="{% get_comment_permalink item.comment %}"><i class="bi bi-link-45deg"></i> Permalink</a></div>
                    {% endspaceless %}
                    <span>
                        {% if not item.comment.is_removed %}
                            {% if perms.comments.can_moderate %}
                                {% if item.flagged_count %}
                                    <span class="badge bg-danger" title="{% blocktrans count counter=item.flagged_count %}A user has flagged this comment as inappropriate.{% plural %}{{ counter }} users have flagged this comment as inappropriate.{% endblocktrans %}">{{ item.flagged_count }}</span>
                                {% endif %}
                            {% endif %}
                            {% if allow_flagging and item.flagged %}
                                <i class="bi bi-flag-fill text-danger" title="{% trans 'comment flagged' %}"></i>
                            {% elif allow_flagging %}
                                    <a class="mutedlink"
                                        href="{% url 'comments-flag' item.comment.pk %}">
                                        <i class="bi bi-flag-fill"></i>
                                    </a>
                            {% endif %}
                            {% if perms.comments.can_moderate %}
                                <a class="mutedlink"
                                href="{% url 'comments-delete' item.comment.pk %}"><i class="bi bi-trash"></i></a>
                            {% endif %}
                        {% endif %}
                    </span>
                </h6>
                {% if item.comment.is_removed %}
                    <p class="text-muted{% if not allow_feedback and not item.comment.allow_thread %} pb-2{% endif %}"><em>{% trans "This comment has been removed." %}</em></p>
                {% else %}
                    <div class="content{% if not allow_feedback and not item.comment.allow_thread %} pb-2{% endif %}">
                        {% include "includes/django_comments_xtd/comment_content.html" with content=item.comment.comment %}
                    </div>
                    {% if allow_feedback %}
                        {% include "includes/django_comments_xtd/user_feedback.html" %}
                    {% endif %}
                    {% if item.comment.allow_thread and not item.comment.is_removed %}
                        {% if allow_feedback %}&nbsp;&nbsp;<span class="text-muted">&bull;</span>&nbsp;&nbsp;{% endif %}<a class="small mutedlink" href="{{ item.comment.get_reply_url }}">{% trans "Reply" %}</a>
                    {% endif %}
                {% endif %}
            </div>
            {% if not item.comment.is_removed and item.children %}
                {% render_xtdcomment_tree with comments=item.children %}
            {% endif %}
        </div>
    </div>

    {% comment %} <div id="comment-{{ item.comment.id }}" class="card mt-2">
        <div class="card-header">
            <h4>
                {% if not item.comment.user and not item.comment.alias_user and item.comment.user_name %}
                    {% if not item.comment.is_removed or user.is_superuser %}
                        {{ item.comment.user_name }}
                    {% endif %}
                {% elif item.comment.alias_user or item.comment.user and item.comment.alias_user %}
                    {% if user.is_superuser %}
                        <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                        <span class="text-small text-muted">{{ item.comment.alias_user }}</span>
                    {% else %}
                        {% if not item.comment.is_removed %}
                            {{ item.comment.alias_user }}
                        {% else %}
                            <span class="text-muted">This comment has been removed.</span>
                        {% endif %}
                    {% endif %}
                {% else %}
                    {% if user.is_superuser or user.id == item.comment.user.id %}
                        <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                    {% elif item.comment.user.owner and user.is_authenticated %}
                        <a href="{{ item.comment.user.get_absolute_url }}">{{ item.comment.user }}</a>
                    {% else %}
                        {{ item.comment.user }}
                    {% endif %}
                {% endif %}

                {% if user.is_authenticated %}
                    <span class="float-end">
                        <div class="btn-group float-end">
                            <a class="btn btn-primary" href="{% url 'comments:comments-reply' pk=item.comment.id %}">
                                <i class="bi bi-reply"></i> Reply
                            </a>

                            {% if user.id == item.comment.user_id or user.is_superuser %}
                                <a class="btn btn-secondary" href="{% url 'comments:comments-edit' pk=item.comment.id %}">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </a>

                                {% if user.is_superuser %}
                                    <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" id="commentActionsDropdown-{{ item.comment.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>

                                    <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="commentActionsDropdown-{{ item.comment.id }}">
                                            {% if item.comment.is_public == False %}
                                                <a class="dropdown-item" href="{% url 'comments-approve' comment_id=item.comment.id %}">
                                                    <i class="bi bi-check2-square"></i> Approve
                                                </a>
                                            {% endif %}

                                            <a class="dropdown-item" href="{% url 'admin:comments_customcomment_change' object_id=item.comment.id %}">
                                                <i class="bi bi-pencil-square"></i> Edit in Admin
                                            </a>
                                    </ul>
                                {% endif %}
                            {% endif %}
                        </div>
                    </span>
                {% endif %}
            </h4>
            <p class="text-muted text-small mb-0">
                <span>{{ item.comment.submit_date|date:'l, d F Y' }}</span>
                -
                <span>
                    <a class="permalink" title="{% trans 'comment permalink' %}" href="{% get_comment_permalink item.comment %}">Â¶</a></div>
                </span>
                {% if item.comment.parent %}
                    -
                    <span>
                        Response to :
                        <a href="{{ item.comment.parent.get_absolute_url }}">
                            <i class="bi bi-link-45deg"></i> {% firstof item.comment.parent.title %} {% if item.comment.parent.title %} - {% endif %}{{ item.comment.parent.comment|truncatechars_html:50 }}
                        </a>
                    </span>
                {% endif %}
            </p>
        </div>
        <div class="card-body">
            {% autoescape on %}
                {% if not item.comment.is_removed and item.comment.title or item.comment.is_removed %}
                    <h5>
                        {% if item.comment.title %}
                            {{ item.comment.title }}
                        {% elif item.comment.is_removed %}
                            <span class="text-muted">This comment has been removed.</span>
                            {% if item.comment.title and user.is_superuser %}
                                <span class="text-small text-muted">{{ item.comment.title }}</span>
                            {% endif %}
                        {% endif %}
                    </h5>
                {% endif %}
                <span class="card-text">
                    {% if not item.comment.is_removed %}
                        {{ item.comment.comment }}
                    {% elif user.is_superuser %}
                        <span class="text-small text-muted">{{ item.comment.comment }}</span>
                    {% endif %}
                </span>
            {% endautoescape %}
        </div>
    </div> {% endcomment %}

{% endfor %}
